name: Run Tests

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        default: 'production'
      skip-integration:  # ‚úÖ ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ÿß€åŸÜ input
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: '1.21.6'
  GO_ENV: production

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.sum

      - name: Run unit tests
        run: |
          echo "üß™ Running unit tests..."
          
          # ÿß€åÿ¨ÿßÿØ ŸÅÿß€åŸÑ ÿ®ÿ±ÿß€å ÿ¨ŸÖÿπ‚Äåÿ¢Ÿàÿ±€å ŸÜÿ™ÿß€åÿ¨
          echo "# Test Results" > test-results.md
          echo "## Unit Tests" >> test-results.md
          
          # ÿ™ÿ≥ÿ™ API Gateway
          if [ -d "./services/api-gateway" ]; then
            echo "üß™ Testing API Gateway..."
            cd ./services/api-gateway
          
            TEST_OUTPUT=$(go test ./... -v -race 2>&1)
            TEST_EXIT_CODE=$?
          
            echo "### API Gateway" >> ../test-results.md
            if [ $TEST_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ All tests passed" >> ../test-results.md
              echo "Exit Code: $TEST_EXIT_CODE" >> ../test-results.md
            else
              echo "‚ùå Tests failed" >> ../test-results.md
              echo "Exit Code: $TEST_EXIT_CODE" >> ../test-results.md
              echo "\`\`\`" >> ../test-results.md
              echo "$TEST_OUTPUT" | tail -50 >> ../test-results.md
              echo "\`\`\`" >> ../test-results.md
            fi
          
            cd ../..
          fi
          
          # ÿ™ÿ≥ÿ™ Auth Service
          if [ -d "./services/auth-service" ]; then
            echo "üß™ Testing Auth Service..."
            cd ./services/auth-service
          
            TEST_OUTPUT=$(go test ./... -v -race 2>&1)
            TEST_EXIT_CODE=$?
          
            echo "### Auth Service" >> ../test-results.md
            if [ $TEST_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ All tests passed" >> ../test-results.md
              echo "Exit Code: $TEST_EXIT_CODE" >> ../test-results.md
            else
              echo "‚ùå Tests failed" >> ../test-results.md
              echo "Exit Code: $TEST_EXIT_CODE" >> ../test-results.md
              echo "\`\`\`" >> ../test-results.md
              echo "$TEST_OUTPUT" | tail -50 >> ../test-results.md
              echo "\`\`\`" >> ../test-results.md
            fi
          
            cd ../..
          fi
          
          # ÿ™ÿ≥ÿ™ shared packages
          if [ -d "./pkg" ]; then
            echo "üß™ Testing shared packages..."
            cd ./pkg
          
            TEST_OUTPUT=$(go test ./... -v -race 2>&1)
            TEST_EXIT_CODE=$?
          
            echo "### Shared Packages" >> ../test-results.md
            if [ $TEST_EXIT_CODE -eq 0 ]; then
              echo "‚úÖ All tests passed" >> ../test-results.md
              echo "Exit Code: $TEST_EXIT_CODE" >> ../test-results.md
            else
              echo "‚ùå Tests failed" >> ../test-results.md
              echo "Exit Code: $TEST_EXIT_CODE" >> ../test-results.md
              echo "\`\`\`" >> ../test-results.md
              echo "$TEST_OUTPUT" | tail -50 >> ../test-results.md
              echo "\`\`\`" >> ../test-results.md
            fi
          
            cd ..
          fi
          
          # ŸÜŸÖÿß€åÿ¥ ŸÜÿ™ÿß€åÿ¨
          echo "üìã Test Results Summary:"
          cat test-results.md
          
          # ÿ®ÿ±ÿ±ÿ≥€å ÿß⁄Øÿ± ÿ™ÿ≥ÿ™‚ÄåŸáÿß fail ÿ¥ÿØŸá‚ÄåÿßŸÜÿØ
          FAILED_COUNT=$(grep -c "‚ùå Tests failed" test-results.md)
          if [ $FAILED_COUNT -gt 0 ]; then
            echo "‚ùå Some tests failed. See details above."
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_id }}
          path: test-results.md

  # üî• ÿ®ÿÆÿ¥ integration tests ŸÅŸÇÿ∑ ÿØÿ± ÿµŸàÿ±ÿ™ ŸÜ€åÿßÿ≤ ÿßÿ¨ÿ±ÿß ÿ¥ŸàÿØ
  integration-tests:
    name: Run Integration Tests
    if: ${{ !inputs.skip-integration && inputs.environment == 'development' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      rabbitmq:
        image: rabbitmq:3-management-alpine
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        options: >-
          --health-cmd "rabbitmq-diagnostics ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5672:5672
          - 15672:15672

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run integration tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: test
          DB_PASSWORD: test
          DB_NAME: test_db
          DB_SSLMODE: disable
          RABBITMQ_URI: amqp://guest:guest@localhost:5672/
        run: |
          echo "üîó Running integration tests..."
          
          # Wait for services to be ready
          echo "‚è≥ Waiting for PostgreSQL..."
          until pg_isready -h localhost -U test; do
            sleep 1
          done
          
          echo "‚è≥ Waiting for RabbitMQ..."
          until curl -f http://localhost:15672; do
            sleep 1
          done
          
          echo "‚úÖ Services are ready"
          
          # Run integration tests if they exist
          for dir in ./services/*; do
            if [ -f "$dir/integration_test.go" ] || [ -d "$dir/integration" ]; then
              echo "üß™ Running integration tests in $dir"
              cd "$dir" && go test -tags=integration ./... -v
              cd ../..
            else
              echo "‚ö†Ô∏è No integration tests found in $dir"
            fi
          done