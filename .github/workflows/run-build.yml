name: Build And Push to Docker Hub

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: 'production'

env:
  DOCKER_HUB_ORG: abbass69
  PROJECT_NAME: microservice

permissions:
  contents: write

jobs:
  build-api-gateway:
    name: Build API Gateway
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: build
        run: |
          REPO="$DOCKER_HUB_ORG/$PROJECT_NAME"
          SHA_TAG="api-gateway-${{ github.sha }}"

          docker build -t $REPO:$SHA_TAG \
            -f infra/development/docker/api-gateway/api-gateway.Dockerfile .

          docker push $REPO:$SHA_TAG

          echo "image=$REPO:$SHA_TAG" >> $GITHUB_OUTPUT

  build-auth-service:
    name: Build Auth Service
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    outputs:
      image: ${{ steps.build.outputs.image }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: build
        run: |
          REPO="$DOCKER_HUB_ORG/$PROJECT_NAME"
          SHA_TAG="auth-service-${{ github.sha }}"

          docker build -t $REPO:$SHA_TAG \
            -f services/auth-service/docker/auth-service.Dockerfile .

          docker push $REPO:$SHA_TAG

          echo "image=$REPO:$SHA_TAG" >> $GITHUB_OUTPUT

  update-kustomize:
    name: Update Kustomize
    needs: [build-api-gateway, build-auth-service]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update kustomization.yml
        run: |
          KUSTOMIZATION_FILE="infra/development/k8s/kustomization.yml"
          
          # Update api-gateway
          API_GATEWAY_IMAGE="${{ needs.build-api-gateway.outputs.image }}"
          API_GATEWAY_TAG="${API_GATEWAY_IMAGE##*:}"
          
          # Update auth-service  
          AUTH_SERVICE_IMAGE="${{ needs.build-auth-service.outputs.image }}"
          AUTH_SERVICE_TAG="${AUTH_SERVICE_IMAGE##*:}"
          
          echo "Updating:"
          echo "  api-gateway -> $API_GATEWAY_TAG"
          echo "  auth-service -> $AUTH_SERVICE_TAG"
          
          # استفاده از yq یا sed برای update
          yq -i "
            (.images[] | select(.name == \"api-gateway\") | .newTag) = \"$API_GATEWAY_TAG\"
            (.images[] | select(.name == \"auth-service\") | .newTag) = \"$AUTH_SERVICE_TAG\"
          " "$KUSTOMIZATION_FILE"
          
          # یا اگر yq ندارید با sed:
          # sed -i "s|api-gateway-.*|$API_GATEWAY_TAG|g" "$KUSTOMIZATION_FILE"
          # sed -i "s|auth-service-.*|$AUTH_SERVICE_TAG|g" "$KUSTOMIZATION_FILE"

      - name: Commit and push changes
        run: |
          if git diff --quiet; then
            echo "No kustomize changes detected."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add infra/development/k8s/kustomization.yml
          git commit -m "chore: update kustomize image tags [ci]"
          git pull --rebase origin develop
          git push origin develop