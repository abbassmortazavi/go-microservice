name: Build And Push to Docker Hub

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: 'production'

env:
  DOCKER_HUB_ORG: abbass69

permissions:
  contents: read

jobs:
  build:
    name: Build and Push Services
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    strategy:
      matrix:
        service:
          - name: api-gateway
            dockerfile: services/api-gateway/api-gateway.Dockerfile
            context: .
          # Add more services here in the future:
          # - name: user-service
          #   dockerfile: services/user-service/Dockerfile
          #   context: services/user-service
          # - name: auth-service
          #   dockerfile: services/auth-service/Dockerfile
          #   context: services/auth-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Dockerfile exists
        run: |
          echo "Checking for Dockerfile: ${{ matrix.service.dockerfile }}"
          if [ ! -f "${{ matrix.service.dockerfile }}" ]; then
            echo "❌ ERROR: Dockerfile not found at ${{ matrix.service.dockerfile }}"
            exit 1
          fi
          echo "✅ Dockerfile found"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build, tag, and push ${{ matrix.service.name }}
        id: build-image
        env:
          IMAGE_TAG: ${{ github.sha }}
          SERVICE_NAME: ${{ matrix.service.name }}
        run: |
          echo "Building service: $SERVICE_NAME"
          echo "Dockerfile: ${{ matrix.service.dockerfile }}"
          echo "Context: ${{ matrix.service.context }}"
          
          REPO_NAME="$DOCKER_HUB_ORG/$SERVICE_NAME"
          echo "Repository: $REPO_NAME"
          echo "Image tag: $IMAGE_TAG"
          
          # Build the image
          docker build -t $REPO_NAME:latest \
                      -t $REPO_NAME:$IMAGE_TAG \
                      -f ${{ matrix.service.dockerfile }} \
                      ${{ matrix.service.context }}
          
          # Push the images
          echo "Pushing images to Docker Hub..."
          docker push $REPO_NAME:latest
          docker push $REPO_NAME:$IMAGE_TAG
          
          # Output the image name for other jobs
          echo "image=$REPO_NAME:$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "✅ Successfully built and pushed $REPO_NAME:$IMAGE_TAG"

      - name: Image digest for ${{ matrix.service.name }}
        run: |
          echo "Image: ${{ steps.build-image.outputs.image }}"
          echo "Digest output available for other jobs"