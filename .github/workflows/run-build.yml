name: Build And Push to Docker Hub

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: 'production'

env:
  DOCKER_HUB_ORG: abbass69
  PROJECT_NAME: microservice
  COMMON_SHA: ${{ github.sha }}

permissions:
  contents: write

jobs:
  build-api-gateway:
    name: Build API Gateway
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    outputs:
      tag: ${{ steps.set-output.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set tag output
        id: set-output
        run: |
          TAG="api-gateway-${{ env.COMMON_SHA }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "API Gateway tag: $TAG"

      - name: Build and push
        run: |
          REPO="${{ env.DOCKER_HUB_ORG }}/${{ env.PROJECT_NAME }}"
          TAG="${{ steps.set-output.outputs.tag }}"
          
          echo "Building $REPO:$TAG"
          
          docker build -t $REPO:$TAG \
            -f infra/development/docker/api-gateway/api-gateway.Dockerfile .
          
          echo "Pushing $REPO:$TAG"
          docker push $REPO:$TAG

  build-auth-service:
    name: Build Auth Service
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    outputs:
      tag: ${{ steps.set-output.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set tag output
        id: set-output
        run: |
          TAG="auth-service-${{ env.COMMON_SHA }}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Auth Service tag: $TAG"

      - name: Build and push
        run: |
          REPO="${{ env.DOCKER_HUB_ORG }}/${{ env.PROJECT_NAME }}"
          TAG="${{ steps.set-output.outputs.tag }}"
          
          echo "Building $REPO:$TAG"
          
          docker build -t $REPO:$TAG \
            -f services/auth-service/docker/auth-service.Dockerfile .
          
          echo "Pushing $REPO:$TAG"
          docker push $REPO:$TAG

  update-kustomize:
    name: Update Kustomize
    needs: [build-api-gateway, build-auth-service]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout on develop branch  # Ù†Ø§Ù… step Ø¨Ø±Ø§ÛŒ clarity
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: develop  # ğŸ”¥ Ø§ÛŒÙ† Ø®Ø· Ø­ÛŒØ§ØªÛŒ Ø§Ø³Øª - Ø±ÙˆÛŒ develop checkout Ú©Ù†

      - name: Debug outputs
        run: |
          echo "API Gateway tag: ${{ needs.build-api-gateway.outputs.tag }}"
          echo "Auth Service tag: ${{ needs.build-auth-service.outputs.tag }}"
          echo "COMMON_SHA: ${{ env.COMMON_SHA }}"

      - name: Update kustomization.yml
        run: |
          KUSTOMIZATION_FILE="infra/development/k8s/kustomization.yml"
          
          # Ø¯Ø±ÛŒØ§ÙØª tags Ø§Ø² outputs
          API_TAG="${{ needs.build-api-gateway.outputs.tag }}"
          AUTH_TAG="${{ needs.build-auth-service.outputs.tag }}"
          
          # fallback Ø§Ú¯Ø± Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯
          [ -z "$API_TAG" ] && API_TAG="api-gateway-${{ env.COMMON_SHA }}"
          [ -z "$AUTH_TAG" ] && AUTH_TAG="auth-service-${{ env.COMMON_SHA }}"
          
          echo "Updating kustomization:"
          echo "  api-gateway -> $API_TAG"
          echo "  auth-service -> $AUTH_TAG"
          
          # Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± ÙØ§ÛŒÙ„
          echo "=== Original kustomization.yml ==="
          cat "$KUSTOMIZATION_FILE"
          echo "================================="
          
          # Ø§Ú¯Ø± ÙÙ‚Ø· ÛŒÚ© image entry Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¢Ù† Ø±Ø§ Ø¨Ù‡ api-gateway Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†ÛŒØ¯
          # Ø§Ú¯Ø± Ø¯Ùˆ entry Ø¯Ø§Ø±ÛŒØ¯ØŒ Ù‡Ø± Ø¯Ùˆ Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†ÛŒØ¯
          if grep -q "name: auth-service" "$KUSTOMIZATION_FILE"; then
            echo "Found auth-service entry, updating both..."
            sed -i "s|newTag: api-gateway-.*|newTag: $API_TAG|" "$KUSTOMIZATION_FILE"
            sed -i "s|newTag: auth-service-.*|newTag: $AUTH_TAG|" "$KUSTOMIZATION_FILE"
          else
            echo "Only api-gateway entry found, updating it..."
            sed -i "s|newTag: api-gateway-.*|newTag: $API_TAG|" "$KUSTOMIZATION_FILE"
            echo "Note: Add auth-service entry to kustomization.yml to update both services"
          fi
          
          echo "=== Updated kustomization.yml ==="
          cat "$KUSTOMIZATION_FILE"
          echo "================================="

      - name: Commit and push changes
        env:
          GIT_USERNAME: "github-actions[bot]"
          GIT_EMAIL: "github-actions[bot]@users.noreply.github.com"
        run: |
          # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
          if git diff --quiet; then
            echo "No changes detected in kustomization.yml"
            exit 0
          fi
          
          echo "Changes detected:"
          git diff
          
          # ØªÙ†Ø¸ÛŒÙ… git config
          git config user.name "$GIT_USERNAME"
          git config user.email "$GIT_EMAIL"
          
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† remote Ø¨Ø§ token
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          
          # Ø§Ø¶Ø§ÙÙ‡ØŒ commit
          git add infra/development/k8s/kustomization.yml
          git commit -m "ci: update image tags to ${{ env.COMMON_SHA }} [skip ci]"
          
          # pull latest Ù‚Ø¨Ù„ Ø§Ø² push
          echo "Pulling latest changes from develop..."
          git pull origin develop --rebase
          
          # push Ø¨Ù‡ develop
          echo "Pushing to develop..."
          git push origin develop
          
          echo "âœ… Successfully updated kustomization.yml"