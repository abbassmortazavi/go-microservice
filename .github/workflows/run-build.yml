name: Build And Push to Docker Hub

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: production

env:
  DOCKER_HUB_ORG: abbass69
  COMMON_SHA: ${{ github.sha }}

permissions:
  contents: write

jobs:
  build-api-gateway:
    name: Build API Gateway
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    outputs:
      image_name: ${{ steps.set-output.outputs.image_name }}
      image_tag: ${{ steps.set-output.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set outputs
        id: set-output
        run: |
          IMAGE_NAME="${{ env.DOCKER_HUB_ORG }}/api-gateway"
          IMAGE_TAG="api-gateway-${{ env.COMMON_SHA }}"

          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          echo "API Gateway: $IMAGE_NAME:$IMAGE_TAG"

      - name: Build and push
        run: |
          IMAGE_NAME="${{ steps.set-output.outputs.image_name }}"
          IMAGE_TAG="${{ steps.set-output.outputs.image_tag }}"

          docker build -t $IMAGE_NAME:$IMAGE_TAG \
            -f infra/development/docker/api-gateway/api-gateway.Dockerfile .

          docker push $IMAGE_NAME:$IMAGE_TAG

  build-auth-service:
    name: Build Auth Service
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    outputs:
      image_name: ${{ steps.set-output.outputs.image_name }}
      image_tag: ${{ steps.set-output.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set outputs
        id: set-output
        run: |
          IMAGE_NAME="${{ env.DOCKER_HUB_ORG }}/auth-service"
          IMAGE_TAG="auth-service-${{ env.COMMON_SHA }}"

          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

          echo "Auth Service: $IMAGE_NAME:$IMAGE_TAG"

      - name: Build and push
        run: |
          IMAGE_NAME="${{ steps.set-output.outputs.image_name }}"
          IMAGE_TAG="${{ steps.set-output.outputs.image_tag }}"

          docker build -t $IMAGE_NAME:$IMAGE_TAG \
            -f services/auth-service/docker/auth-service.Dockerfile .

          docker push $IMAGE_NAME:$IMAGE_TAG

  update-kustomize:
    name: Update Kustomize
    needs:
      - build-api-gateway
      - build-auth-service
    runs-on: ubuntu-latest

    steps:
      - name: Checkout on develop branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: develop

      - name: Debug outputs
        run: |
          echo "API Gateway:"
          echo "  name: ${{ needs.build-api-gateway.outputs.image_name }}"
          echo "  tag: ${{ needs.build-api-gateway.outputs.image_tag }}"
          echo ""
          echo "Auth Service:"
          echo "  name: ${{ needs.build-auth-service.outputs.image_name }}"
          echo "  tag: ${{ needs.build-auth-service.outputs.image_tag }}"

      - name: Update kustomization.yml
        run: |
          KUSTOMIZATION_FILE="infra/development/k8s/kustomization.yml"

          API_GATEWAY_NAME="${{ needs.build-api-gateway.outputs.image_name }}"
          API_GATEWAY_TAG="${{ needs.build-api-gateway.outputs.image_tag }}"

          AUTH_SERVICE_NAME="${{ needs.build-auth-service.outputs.image_name }}"
          AUTH_SERVICE_TAG="${{ needs.build-auth-service.outputs.image_tag }}"

          cat > "$KUSTOMIZATION_FILE" <<EOF
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: production

resources:
  - api-gateway
  - auth-service
  - postgres-service
  - rabbitmq-service

images:
  - name: api-gateway
    newName: ${API_GATEWAY_NAME}
    newTag: ${API_GATEWAY_TAG}

  - name: auth-service
    newName: ${AUTH_SERVICE_NAME}
    newTag: ${AUTH_SERVICE_TAG}
  EOF

- name: Commit and push changes
  run: |
    if git diff --quiet; then
      echo "No changes detected"
      exit 0
    fi
    
    git config user.name "github-actions[bot]"
    git config user.email "github-actions[bot]@users.noreply.github.com"
    
    git add infra/development/k8s/kustomization.yml
    git commit -m "ci: update service image tags [skip ci]"
    git push origin develop
