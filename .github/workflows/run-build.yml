name: Build And Push to Docker Hub

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: 'production'

env:
  DOCKER_HUB_ORG: abbass69
  PROJECT_NAME: microservice

permissions:
  contents: read

jobs:
  build:
    name: Build and Push Services
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    strategy:
      matrix:
        service:
          - name: api-gateway
            dockerfile: infra/development/docker/api-gateway/api-gateway.Dockerfile
            context: .
          # Add more services here in the future:
          # - name: user-service
          #   dockerfile: services/user-service/Dockerfile
          #   context: services/user-service

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Dockerfile exists
        run: |
          echo "Checking for Dockerfile: ${{ matrix.service.dockerfile }}"
          if [ ! -f "${{ matrix.service.dockerfile }}" ]; then
            echo "❌ ERROR: Dockerfile not found at ${{ matrix.service.dockerfile }}"
            exit 1
          fi
          echo "✅ Dockerfile found"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build, tag, and push ${{ matrix.service.name }}
        id: build-image
        env:
          IMAGE_TAG: ${{ github.sha }}      # Using Git commit SHA as the tag
          SERVICE_NAME: ${{ matrix.service.name }}
        run: |
          echo "Building service: $SERVICE_NAME"
          echo "Dockerfile: ${{ matrix.service.dockerfile }}"
          echo "Context: ${{ matrix.service.context }}"

          REPO_NAME="$DOCKER_HUB_ORG/$PROJECT_NAME"
          LATEST_TAG="$SERVICE_NAME-latest"
          SHA_TAG="$SERVICE_NAME-$IMAGE_TAG"
          
          echo "Repository: $REPO_NAME"
          echo "Latest tag: $LATEST_TAG"
          echo "SHA tag: $SHA_TAG"

          # Build Docker image with two tags
          docker build -t $REPO_NAME:$LATEST_TAG \
                      -t $REPO_NAME:$SHA_TAG \
                      -f ${{ matrix.service.dockerfile }} \
                      ${{ matrix.service.context }}
          
          # Push images with both tags
          echo "Pushing images to Docker Hub..."
          docker push $REPO_NAME:$LATEST_TAG
          docker push $REPO_NAME:$SHA_TAG
          
          # Output the image names for use in other jobs
          echo "image=$REPO_NAME:$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "image_sha=$REPO_NAME:$SHA_TAG" >> $GITHUB_OUTPUT
          echo "✅ Successfully built and pushed $REPO_NAME:$LATEST_TAG"

      - name: Image digest for ${{ matrix.service.name }}
        run: |
          echo "Latest image: ${{ steps.build-image.outputs.image }}"
          echo "SHA image: ${{ steps.build-image.outputs.image_sha }}"

      # Step to Update Kustomize for the new image tag
      - name: Update Kustomize with new image tag
        run: |
          echo "Updating Kustomize with image tag: ${{ steps.build-image.outputs.image_sha }}"
          IMAGE_TAG="${{ steps.build-image.outputs.image_sha }}"
          
          KUSTOMIZATION_FILE="infra/development/k8s/kustomization.yaml"
      
          if [ ! -f "$KUSTOMIZATION_FILE" ]; then
          echo "❌ ERROR: Kustomization file not found at $KUSTOMIZATION_FILE"
          exit 1
          fi

          sed -i "s|abbass69/microservice:api-gateway.*|$IMAGE_TAG|" "$KUSTOMIZATION_FILE"
          
          git add "$KUSTOMIZATION_FILE"
          git commit -m "Update Kustomize with new image tag: $IMAGE_TAG"
          git push
