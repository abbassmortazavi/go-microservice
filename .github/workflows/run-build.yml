name: Build And Push to Docker Hub
on:
  workflow_dispatch:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: 'production'
env:
  DOCKER_HUB_ORG: abbass69
  COMMON_SHA: ${{ github.sha }}
permissions:
  contents: write
jobs:
  build-api-gateway:
    name: Build API Gateway
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    outputs:
      image_name: ${{ steps.set-output.outputs.image_name }}
      image_tag: ${{ steps.set-output.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set outputs
        id: set-output
        run: |
          REPO="${{ env.DOCKER_HUB_ORG }}/api-gateway"
          TAG="api-gateway-${{ env.COMMON_SHA }}"
          
          echo "image_name=$REPO" >> $GITHUB_OUTPUT
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          
          echo "API Gateway: $REPO:$TAG"

      - name: Build and push
        run: |
          REPO="${{ steps.set-output.outputs.image_name }}"
          TAG="${{ steps.set-output.outputs.image_tag }}"
          
          echo "Building $REPO:$TAG and $REPO:latest"
          
          # ساخت ایمیج با دو تگ
          docker build -t $REPO:$TAG -t $REPO:latest \
            -f infra/development/docker/api-gateway/api-gateway.Dockerfile .
          
          echo "Pushing $REPO:$TAG"
          docker push $REPO:$TAG
          
          echo "Pushing $REPO:latest"
          docker push $REPO:latest

  build-auth-service:
    name: Build Auth Service
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    outputs:
      image_name: ${{ steps.set-output.outputs.image_name }}
      image_tag: ${{ steps.set-output.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set outputs
        id: set-output
        run: |
          REPO="${{ env.DOCKER_HUB_ORG }}/auth-service"
          TAG="auth-service-${{ env.COMMON_SHA }}"
          
          echo "image_name=$REPO" >> $GITHUB_OUTPUT
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          
          echo "Auth Service: $REPO:$TAG"

      - name: Build and push
        run: |
          REPO="${{ steps.set-output.outputs.image_name }}"
          TAG="${{ steps.set-output.outputs.image_tag }}"
          
          echo "Building $REPO:$TAG and $REPO:latest"
          
          # ساخت ایمیج با دو تگ
          docker build -t $REPO:$TAG -t $REPO:latest \
            -f services/auth-service/docker/auth-service.Dockerfile .
          
          echo "Pushing $REPO:$TAG"
          docker push $REPO:$TAG
          
          echo "Pushing $REPO:latest"
          docker push $REPO:latest

  update-kustomize:
    name: Update Kustomize
    needs: [build-api-gateway, build-auth-service]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout on develop branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          ref: develop

      - name: Update kustomization.yml
        run: |
          KUSTOMIZATION_FILE="infra/development/k8s/kustomization.yml"

          # اطلاعات api-gateway
          API_GATEWAY_NAME="${{ needs.build-api-gateway.outputs.image_name }}"
          API_GATEWAY_TAG="${{ needs.build-api-gateway.outputs.image_tag }}"
          
          # اطلاعات auth-service
          AUTH_SERVICE_NAME="${{ needs.build-auth-service.outputs.image_name }}"
          AUTH_SERVICE_TAG="${{ needs.build-auth-service.outputs.image_tag }}"
          
          echo "Updating kustomization:"
          echo "  api-gateway: $API_GATEWAY_NAME:$API_GATEWAY_TAG"
          echo "  auth-service: $AUTH_SERVICE_NAME:$AUTH_SERVICE_TAG"
          
          # ایجاد یا آپدیت فایل
          cat > "$KUSTOMIZATION_FILE" << EOF
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          
          namespace: production
          
          resources:
            - api-gateway/api-gateway-deployment.yaml
            - app-config.yaml
            - api-gateway/api-gateway-service.yaml
            - auth-service/auth-service.yaml
            - auth-service/auth-service-deployment.yaml
            - postgres-service/postgres-deployment.yaml
            - postgres-service/postgres-service.yaml
            - rabbitmq-service/rabbitmq-deployment.yaml
            - rabbitmq-service/rabbitmq-service.yaml
          
          images:
            - name: api-gateway  # باید با container name در deployment هماهنگ باشد
              newName: $API_GATEWAY_NAME
              newTag: $API_GATEWAY_TAG
          
            - name: auth-service  # باید با container name در deployment هماهنگ باشد
              newName: $AUTH_SERVICE_NAME
              newTag: $AUTH_SERVICE_TAG
          EOF
          
          echo "Updated kustomization.yml:"
          cat "$KUSTOMIZATION_FILE"

      - name: Commit and push changes
        env:
          GIT_USERNAME: "github-actions[bot]"
          GIT_EMAIL: "github-actions[bot]@users.noreply.github.com"
        run: |
          if git diff --quiet; then
            echo "No changes detected"
            exit 0
          fi
          
          git config user.name "$GIT_USERNAME"
          git config user.email "$GIT_EMAIL"
          
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}
          
          git add infra/development/k8s/kustomization.yml
          git commit -m "ci: update image tags [skip ci]"
          
          git pull origin develop --rebase
          git push origin develop
          
          echo "✅ Successfully updated kustomization.yml"