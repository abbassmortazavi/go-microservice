name: Build And Push to Docker Hub

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      environment:
        required: false
        type: string
        default: 'production'

env:
  DOCKER_HUB_ORG: abbass69
  PROJECT_NAME: microservice

permissions:
  contents: write

jobs:
  build:
    name: Build and Push Services
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    strategy:
      matrix:
        service:
          - name: api-gateway
            dockerfile: infra/development/docker/api-gateway/api-gateway.Dockerfile
            context: .
          - name: auth-service
            dockerfile: services/auth-service/docker/auth-service.Dockerfile
            context: .

    outputs:
      images: ${{ steps.collect.outputs.images }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build, tag, and push ${{ matrix.service.name }}
        id: build-image
        env:
          IMAGE_TAG: ${{ github.sha }}
          SERVICE_NAME: ${{ matrix.service.name }}
        run: |
          REPO="$DOCKER_HUB_ORG/$PROJECT_NAME"
          SHA_TAG="$SERVICE_NAME-$IMAGE_TAG"

          docker build -t $REPO:$SHA_TAG \
            -f ${{ matrix.service.dockerfile }} \
            ${{ matrix.service.context }}

          docker push $REPO:$SHA_TAG

          echo "$SERVICE_NAME=$REPO:$SHA_TAG" >> images.txt

      - name: Collect image outputs
        id: collect
        run: |
          echo "images<<EOF" >> $GITHUB_OUTPUT
          cat images.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  update-kustomize:
    name: Update Kustomize
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update kustomization.yml
        run: |
          KUSTOMIZATION_FILE="infra/development/k8s/kustomization.yml"

          echo "${{ needs.build.outputs.images }}" | while read line; do
            SERVICE=$(echo "$line" | cut -d= -f1)
            IMAGE=$(echo "$line" | cut -d= -f2)
            TAG="${IMAGE##*:}"

            echo "Updating $SERVICE -> $TAG"

            yq -i "
              (.images[] | select(.name == \"$SERVICE\") | .newTag) = \"$TAG\"
            " "$KUSTOMIZATION_FILE"
          done

      - name: Commit and push changes
        run: |
          if git diff --quiet; then
            echo "No kustomize changes detected."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add infra/development/k8s/kustomization.yml
          git commit -m "chore: update kustomize image tags [ci]"
          git pull --rebase origin develop
          git push origin develop
